<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Contratos | Ag√™ncia Tribo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body.dark-mode {
      background-color: #121212;
      color: #f1f1f1;
    }
    .navbar-dark .nav-link {
      color: #f1f1f1 !important;
    }
    .table-dark-mode {
      background-color: #1e1e1e;
      color: #f1f1f1;
    }
    .table-dark-mode thead {
      background-color: #2c2c2c;
    }
    .alert-dark-mode {
      background-color: #333;
      color: #f1f1f1;
      border-color: #555;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Menu superior -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
    <a class="navbar-brand fw-bold" href="/">Ag√™ncia Tribo</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/">üè† Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/solicitar">üìù Solicitar Contrato</a></li>
        <li class="nav-item"><a class="nav-link active" href="/dashboard">üìÑ Dashboard</a></li>
      </ul>
    </div>
    <button onclick="alternarTema()" class="btn btn-outline-light ms-3">
      <i id="temaIcone" class="bi bi-moon"></i>
    </button>
  </nav>

  <!-- Conte√∫do principal -->
  <div class="container py-5">
    <h2 class="mb-4">üìÑ Contratos Pendentes</h2>

    <table id="tabela" class="table table-bordered bg-white shadow-sm table-responsive">
      <thead class="table-light">
        <tr>
          <th>Nome</th>
          <th>Servi√ßo</th>
          <th>Empresa</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabela-contratos">
        <!-- Linhas geradas dinamicamente -->
      </tbody>
    </table>

    <div id="alerta" class="alert d-none mt-3" role="alert"></div>
  </div>

  <script>
    async function carregarContratos() {
      const resposta = await fetch('/api/contratos');
      const contratos = await resposta.json();

      const tabela = document.getElementById("tabela-contratos");
      tabela.innerHTML = '';

      contratos.forEach(c => {
        const linha = document.createElement("tr");
        linha.innerHTML = `
          <td>${c.nome}</td>
          <td>${c.servico}</td>
          <td>${c.empresa}</td>
          <td>
            <a href="/aprovar?id=${c.id}" class="btn btn-success btn-sm btn-aprovar">
              <i class="bi bi-check-circle"></i> Aprovar
            </a>
          </td>
        `;
        tabela.appendChild(linha);
      });

      ativarBotoes();
    }

    function ativarBotoes() {
      document.querySelectorAll('.btn-aprovar').forEach(botao => {
        botao.addEventListener('click', async (e) => {
          e.preventDefault();
          const url = botao.getAttribute('href');

          try {
            const resposta = await fetch(url);
            const texto = await resposta.text();
            mostrarAlerta(texto, 'success');
            carregarContratos(); // atualiza ap√≥s aprova√ß√£o
          } catch (erro) {
            mostrarAlerta('‚ùå Erro ao aprovar contrato.', 'danger');
          }
        });
      });
    }

    function mostrarAlerta(mensagem, tipo) {
      const alerta = document.getElementById('alerta');
      alerta.textContent = mensagem;
      alerta.className = `alert alert-${tipo} mt-3`;
      if (document.body.classList.contains('dark-mode')) {
        alerta.classList.add('alert-dark-mode');
      } else {
        alerta.classList.remove('alert-dark-mode');
      }
      alerta.classList.remove('d-none');
    }

    function alternarTema() {
      document.body.classList.toggle('dark-mode');
      document.getElementById('tabela').classList.toggle('table-dark-mode');
      const icone = document.getElementById('temaIcone');
      icone.classList.toggle('bi-moon');
      icone.classList.toggle('bi-sun');
    }

    carregarContratos();
  </script>
</body>
</html>
